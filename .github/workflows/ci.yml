name: test_vue_build
on: [push]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v6
        with:
          node-version: 24
      - name: Install dependencies
        run: npm ci
      - name: Run build
        run: npm run build
      - name: Debug info
        run: |
          echo "当前目录: $(pwd)"
          echo "Node版本: $(node --version)"
          echo "NPM版本: $(npm --version)"
          ls -la
          ls -la dist/
      - name: Health check
        run: |
          echo "✅ 构建质量检查:"
          echo "- HTML文件大小: $(stat -c%s dist/index.html) 字节"
          echo "- Assets文件数: $(find dist/assets -type f | wc -l) 个"
          echo "- 总构建文件数: $(find dist -type f | wc -l) 个"

          if grep -q "DOCTYPE html" dist/index.html; then
            echo "✅ HTML结构正确"
          else
            echo "❌ HTML可能有问题"
          fi
      - name: Setup Aliyun CLI
        run: |
          # 安装
          /bin/bash -c "$(curl -fsSL https://aliyuncli.alicdn.com/install.sh)"

          # 验证
          aliyun version
          # 配置
          aliyun configure set \
            --profile default \
            --mode AK \
            --access-key-id "${{ secrets.OSS_ACCESS_KEY_ID }}" \
            --access-key-secret "${{ secrets.OSS_ACCESS_KEY_SECRET }}" \
            --region "${{ secrets.OSS_REGION }}"
      - name: Test OSS permissions
        env:
          OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
        run: |
          set -e  # 遇到错误立即停止

          # 测试基本操作
          echo "1. 测试Bucket列表..."
          aliyun oss ls

          echo "2. 测试文件列表..."
          aliyun oss ls oss://$OSS_BUCKET/

          echo "3. 测试上传文件..."
          echo "GitHub Actions Permission Test" > test-permission.txt
          aliyun oss cp test-permission.txt oss://$OSS_BUCKET/test-permission.txt

          echo "4. 测试读取文件..."
          aliyun oss cat oss://$OSS_BUCKET/test-permission.txt

          echo "5. 测试删除文件..."
          aliyun oss rm oss://$OSS_BUCKET/test-permission.txt

          echo "6. 测试文件存在检查..."
          aliyun oss ls oss://$OSS_BUCKET/ | head -5 || echo "Bucket为空"

          echo "✅ 所有权限测试通过！"
