name: test_vue_build
on: [push]
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - uses: actions/setup-node@v6
        with:
          node-version: 24
      - name: Install dependencies
        run: npm ci
      - name: Run build
        run: npm run build
      - name: Debug info
        run: |
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "Nodeç‰ˆæœ¬: $(node --version)"
          echo "NPMç‰ˆæœ¬: $(npm --version)"
          ls -la
          ls -la dist/
      - name: Health check
        run: |
          echo "âœ… æ„å»ºè´¨é‡æ£€æŸ¥:"
          echo "- HTMLæ–‡ä»¶å¤§å°: $(stat -c%s dist/index.html) å­—èŠ‚"
          echo "- Assetsæ–‡ä»¶æ•°: $(find dist/assets -type f | wc -l) ä¸ª"
          echo "- æ€»æ„å»ºæ–‡ä»¶æ•°: $(find dist -type f | wc -l) ä¸ª"

          if grep -q "DOCTYPE html" dist/index.html; then
            echo "âœ… HTMLç»“æ„æ­£ç¡®"
          else
            echo "âŒ HTMLå¯èƒ½æœ‰é—®é¢˜"
          fi
      - name: Setup Aliyun CLI
        run: |
          # å®‰è£…
          /bin/bash -c "$(curl -fsSL https://aliyuncli.alicdn.com/install.sh)"

          # éªŒè¯
          aliyun version
          # é…ç½®
          aliyun configure set \
            --profile default \
            --mode AK \
            --access-key-id "${{ secrets.OSS_ACCESS_KEY_ID }}" \
            --access-key-secret "${{ secrets.OSS_ACCESS_KEY_SECRET }}" \
            --region "${{ secrets.OSS_REGION }}"
      - name: Test OSS permissions
        env:
          OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
        run: |
          set -e
          echo "1. æµ‹è¯•æ–‡ä»¶åˆ—è¡¨..."
          aliyun oss ls oss://$OSS_BUCKET/

          echo "2. æµ‹è¯•ä¸Šä¼ æ–‡ä»¶..."
          echo "GitHub Actions Test" > test-actions.txt
          aliyun oss cp test-actions.txt oss://$OSS_BUCKET/test-actions.txt

          echo "3. æµ‹è¯•è¯»å–æ–‡ä»¶..."
          aliyun oss cat oss://$OSS_BUCKET/test-actions.txt

          echo "4. æµ‹è¯•åˆ é™¤æ–‡ä»¶..."
          aliyun oss rm oss://$OSS_BUCKET/test-actions.txt

          echo "âœ… æ‰€æœ‰æƒé™æµ‹è¯•é€šè¿‡ï¼"
      - name: Deploy with cleanup
        env:
          OSS_BUCKET: ${{ secrets.OSS_BUCKET }}
        run: |
          echo "ğŸ§¹ æ¸…ç†æ—§çš„æ„å»ºèµ„æº..."
          # åˆ é™¤æ—§çš„ JS/CSS æ–‡ä»¶ï¼ˆä¿ç•™å½“å‰æ„å»ºï¼‰
          aliyun oss rm oss://$OSS_BUCKET/assets/ --recursive -f || true

          echo "ğŸš€ ä¸Šä¼ æ–°ç‰ˆæœ¬..."
          aliyun oss cp ./dist/ oss://$OSS_BUCKET/ -r

          echo "âœ… éƒ¨ç½²å®Œæˆï¼"
